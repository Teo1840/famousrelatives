<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Famous Relatives</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&family=Open+Sans&display=swap" rel="stylesheet">
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>
body {
  font-family: "Open Sans", sans-serif;
  background-color: #ececec;
  color: #222;
  margin: 0;
  padding: 0;
}

/* Títulos */
h1, h2 {
  font-family: "Poppins", sans-serif;
  font-weight: 600;
  text-align: center;
  color: #111;
  margin-top: 20px;
}

/* Tarjetas */
.grid-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  justify-items: center;
  margin: 20px auto;
  max-width: 1000px;
}
@media (max-width:900px){.grid-container{grid-template-columns:repeat(2,1fr);} }
@media (max-width:600px){.grid-container{grid-template-columns:1fr;}}

.card {
  cursor: pointer;
  border-radius: 10px;
  padding: 12px;
  width: 90%;
  max-width: 280px;
  text-align: center;
  background: white;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  transition: 0.2s;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
}
.card h3 {
  font-family: "Poppins", sans-serif;
  font-weight: 600;
  margin-bottom: 6px;
}

/* Popup */
.popup-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.popup-content {
  background: white;
  border-radius: 12px;
  padding: 20px;
  width: 85%;
  max-width: 1000px;
  max-height: 85%;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  position: relative;
  font-family: "Open Sans", sans-serif;
}

.popup-content h3 {
  font-family: "Poppins", sans-serif;
  font-weight: 600;
  font-size: 1.6em;
  color: #222;
  margin-bottom: 10px;
}

.popup-content pre {
  background: #f8f8f8;
  padding: 10px;
  border-radius: 8px;
  white-space: pre-wrap;
}

/* Contenedor del grafo */
#mynetwork {
  width: 100%;
  height: 500px;
  border: 1px solid #ddd;
  margin-top: 10px;
  border-radius: 8px;
}

/* Botones */
#toggleCoParents {
  background-color: #f3f7fe;
  color: #3b82f6;
  border: none;
  cursor: pointer;
  border-radius: 8px;
  width: 300px;
  height: 45px;
  transition: 0.3s;
  padding: 6px 12px;
  font-family: "Poppins", sans-serif;
}
#toggleCoParents:hover {
  background-color: #3b82f6;
  box-shadow: 0 0 0 5px #3b83f65f;
  color: #fff;
}
.popup-close {
  position: absolute;
  top: 8px; right: 12px;
  cursor: pointer;
  font-weight: bold;
  font-size: 20px;
  color: #333;
}

/* Botones de navegación externos */
.popup-nav {
  position: fixed;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,123,255,0.85);
  color: white;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 22px;
  cursor: pointer;
  z-index: 1100;
}

.popup-nav:hover {
  background: #0056b3;
}

.popup-nav.left {
  left: 40px;
}

.popup-nav.right {
  right: 40px;
}
</style>
</head>
<body>
<h1>Famous Relatives</h1>
<h2>*En rosado claro se encuentran los parentescos políticos y en rosado oscuro parentescos de mi cónyuge*</h2>

<button id="toggleCoParents">- Ocultar parentescos de mi cónyuge</button>

<div class="grid-container">
  {{TARJETAS}}
</div>

<div id="popup" class="popup-overlay" onclick="closePopup(event)">
  <button class="popup-nav left" onclick="prevPopup(event)">&#8592;</button>
  <button class="popup-nav right" onclick="nextPopup(event)">&#8594;</button>

  <div class="popup-content" onclick="event.stopPropagation()">
    <span class="popup-close" onclick="closePopup(event)">&times;</span>
    <div id="popup-body"></div>
    <div id="mynetwork"></div>
  </div>
</div>

<script>
// ====================
// Variables globales
// ====================
let currentIndex = 0;

// ====================
// Array de arboles reemplazado por Python
// ====================
// const arboles = {{ARBOL_JS}}; // <-- Python debe reemplazar este marcador con JSON válido

// ====================
// Funciones Popup
// ====================
function openPopup(i) {
  if(!arboles || arboles.length === 0) return;
  currentIndex = i;
  showPopup();
  document.getElementById('popup').style.display = 'flex';
}

function closePopup(e) {
  document.getElementById('popup').style.display = 'none';
}

function nextPopup(e) {
  e.stopPropagation();
  if(!arboles || arboles.length === 0) return;
  currentIndex = (currentIndex + 1) % arboles.length;
  showPopup();
}

function prevPopup(e) {
  e.stopPropagation();
  if(!arboles || arboles.length === 0) return;
  currentIndex = (currentIndex - 1 + arboles.length) % arboles.length;
  showPopup();
}

// ====================
// Mostrar Popup + Grafo
// ====================
function showPopup() {
  const a = arboles[currentIndex];

  // Info textual
  document.getElementById('popup-body').innerHTML = `
    <h3>${a.nombre}</h3>
    <img src="${a.portraitUrl || 'https://via.placeholder.com/200'}" width="200">
    <p><i>${a.relacion || ''}</i></p>
    <p><b>Cercanía:</b> ${a.cercania || ''}</p>
    <p>${a.extra || ''}</p>
    <pre>${a.detalle || ''}</pre>`;

  const nodes = [];
  const edges = [];

  // Nodo raíz (antepasado común) abajo, ya que usamos "DU"
  const rootId = a.antepasado_comun?.id || crypto.randomUUID();
  nodes.push({
    id: rootId,
    label: `${a.antepasado_comun?.nombre || 'Desconocido'}\n${a.antepasado_comun?.lifespan || ''}`,
    shape: 'image',
    image: a.antepasado_comun?.portraitUrl || 'https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png',
    font: { size: 16 },
    color: { border: 'red', background: '#ffe6e6' }
  });

  // Rama ascendente: conectada en cadena hacia la raíz
  const ascendingNodes = (a.camino_ascendente || []).slice()//.reverse(); // invertir para que el nodo más lejano quede arriba
  let previousId = rootId;
  ascendingNodes.forEach(p => {
    const id = p.id || crypto.randomUUID();
    nodes.push({
      id,
      label: `${p.nombre}\n${p.lifespan || ''}`,
      shape: 'image',
      image: p.portraitUrl || 'https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png',
      font: { size: 16 }
    });
    edges.push({ from: id, to: previousId }); // conectar con el nodo anterior (o raíz)
    previousId = id; // siguiente nodo se conecta a este
  });

  // Rama descendente: conectada directamente a la raíz
  let previousDescId = rootId;
  (a.camino_descendente || []).forEach(p => {
    const id = p.id || crypto.randomUUID();
    nodes.push({
      id,
      label: `${p.nombre}\n${p.lifespan || ''}`,
      shape: 'image',
      image: p.portraitUrl || 'https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png',
      font: { size: 16 }
    });
    edges.push({ from: previousDescId, to: id });
    previousDescId = id;
  });

  // Renderizar con vis.js
  const container = document.getElementById('mynetwork');
  if (window.network) window.network.destroy(); // destruir grafo anterior
  const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
  const options = {
    layout: { hierarchical: { direction: "DU", sortMethod: "directed", nodeSpacing: 150 } },
    nodes: { borderWidth: 2, shape: "image", brokenImage: "https://via.placeholder.com/100" },
    edges: { smooth: false, color: { color: "#888" } },
    physics: false
  };
  window.network = new vis.Network(container, data, options);
}

// ====================
// Toggle coParentIsPathPerson
// ====================
document.addEventListener("DOMContentLoaded", function() {
  const toggleBtn = document.getElementById("toggleCoParents");
  let hidden = false;
  toggleBtn.addEventListener("click", function() {
    document.querySelectorAll(".card").forEach(c => {
      if(c.dataset.coParent === "true") c.style.display = hidden ? "block" : "none";
    });
    hidden = !hidden;
    toggleBtn.textContent = hidden
      ? "+ Mostrar parentescos de mi cónyuge"
      : "- Ocultar parentescos de mi cónyuge";
  });
});
</script>
</body>
</html>